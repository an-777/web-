<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°æ•¸é»éš¨æ©Ÿé–“éš” - è‡ªå‹•æƒæå™¨</title>
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; }
        input[type="text"], input[type="number"] {
            width: 100%; padding: 10px; margin-bottom: 10px; font-size: 14px;
            border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box;
        }
        .controls { display: flex; gap: 10px; align-items: center; margin-bottom: 20px; }
        button {
            padding: 10px 25px; font-size: 16px; cursor: pointer;
            background-color: #28a745; color: white; border: none; border-radius: 5px;
        }
        button:hover { background-color: #218838; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        button#btnStop { background-color: #dc3545; }
        
        .row { display: flex; gap: 20px; margin-bottom: 10px; }
        .col { flex: 1; }

        .log { padding: 15px; background: #f8f9fa; border: 1px solid #ddd; height: 350px; overflow-y: auto; font-family: monospace; }
        .item { margin-bottom: 5px; border-bottom: 1px dashed #eee; padding-bottom: 2px;}
        .highlight { color: #0056b3; font-weight: bold; }
        .wait-time { color: #e67e22; font-weight: bold; }
    </style>
</head>
<body>

    <h2>NCU è‡ªå‹•é»å (æ”¯æ´å°æ•¸é»ç§’æ•¸)</h2>
    
    <label>åŸå§‹é€£çµï¼š</label>
    <input type="text" id="urlInput" value="https://ncueeclass.ncu.edu.tw/course/joinOnSite?courseId=35214&date=2025-09-25&timeTableType=2&timeTableId=12501&week=0&classTimeId=0">

    <div class="row">
        <div class="col">
            <label>å˜—è©¦æ¬¡æ•¸ (æƒæç¯„åœ)ï¼š</label>
            <input type="number" id="retryCount" value="20">
        </div>
        <div class="col">
            <label>æœ€å°åœç•™ç§’æ•¸ (å¯å°æ•¸)ï¼š</label>
            <input type="number" id="minSec" value="1.5" step="0.1">
        </div>
        <div class="col">
            <label>æœ€å¤§åœç•™ç§’æ•¸ (å¯å°æ•¸)ï¼š</label>
            <input type="number" id="maxSec" value="3.5" step="0.1">
        </div>
    </div>

    <div class="controls">
        <button id="btnStart" onclick="startProcess()">ğŸš€ é–‹å§‹æƒæ</button>
        <button id="btnStop" onclick="stopProcess()" disabled>â›” åœæ­¢</button>
        <span id="statusText" style="font-weight: bold; color: #d9534f;"></span>
    </div>

    <div id="logArea" class="log">æº–å‚™å°±ç·’...</div>

    <script>
        const logArea = document.getElementById('logArea');
        const btnStart = document.getElementById('btnStart');
        const btnStop = document.getElementById('btnStop');
        const statusText = document.getElementById('statusText');
        
        let isRunning = false;

        function log(message) {
            const div = document.createElement('div');
            div.className = 'item';
            div.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}`;
            logArea.appendChild(div);
            logArea.scrollTop = logArea.scrollHeight;
        }

        function getTodayDateString() {
            const d = new Date();
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // ç”¢ç”Ÿç¯„åœå…§çš„éš¨æ©Ÿæµ®é»æ•¸
        function getRandomFloat(min, max) {
            return Math.random() * (max - min) + min;
        }

        function stopProcess() {
            isRunning = false;
            log("ğŸ›‘ ä½¿ç”¨è€…å·²æ‰‹å‹•åœæ­¢");
            btnStart.disabled = false;
            btnStop.disabled = true;
            statusText.innerText = "å·²åœæ­¢";
        }

        async function startProcess() {
            const rawUrl = document.getElementById('urlInput').value.trim();
            const maxRetries = parseInt(document.getElementById('retryCount').value, 10);
            
            // ä½¿ç”¨ parseFloat è§£æå°æ•¸
            const minSec = parseFloat(document.getElementById('minSec').value);
            const maxSec = parseFloat(document.getElementById('maxSec').value);

            if (!rawUrl) { alert("è«‹è¼¸å…¥ç¶²å€"); return; }
            if (isNaN(minSec) || isNaN(maxSec)) { alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„ç§’æ•¸"); return; }
            if (minSec > maxSec) { alert("æœ€å°ç§’æ•¸ä¸èƒ½å¤§æ–¼æœ€å¤§ç§’æ•¸ï¼"); return; }

            let urlObj;
            try { urlObj = new URL(rawUrl); } catch (e) { alert("ç¶²å€æ ¼å¼éŒ¯èª¤"); return; }

            const todayStr = getTodayDateString();
            urlObj.searchParams.set('date', todayStr);
            
            let currentId = parseInt(urlObj.searchParams.get('timeTableId'));
            if (isNaN(currentId)) { alert("ç¶²å€å…§ç¼ºå°‘ timeTableId"); return; }

            isRunning = true;
            btnStart.disabled = true;
            btnStop.disabled = false;
            logArea.innerHTML = "";
            log(`ğŸ“… è¨­å®šæ—¥æœŸï¼š${todayStr}`);
            log(`ğŸ² éš¨æ©Ÿé–“éš”ï¼š${minSec} ~ ${maxSec} ç§’`);

            for (let i = 0; i < maxRetries; i++) {
                if (!isRunning) break;

                urlObj.searchParams.set('timeTableId', currentId + i);
                const targetUrl = urlObj.toString();

                // è¨ˆç®—éš¨æ©Ÿç§’æ•¸ (ä¿ç•™å°æ•¸é‹ç®—)
                const waitTimeRaw = getRandomFloat(minSec, maxSec);
                // ç‚ºäº†æ—¥èªŒå¥½çœ‹ï¼Œå–å°æ•¸é»å¾Œå…©ä½é¡¯ç¤º
                const waitTimeDisplay = waitTimeRaw.toFixed(2);
                // è½‰æˆæ¯«ç§’ä¾› setTimeout ä½¿ç”¨
                const waitTimeMs = waitTimeRaw * 1000;
                
                statusText.innerText = `åŸ·è¡Œä¸­ (${i + 1}/${maxRetries})`;
                log(`é–‹å•Ÿ: <span class="highlight">ID=${currentId + i}</span> (åœç•™ <span class="wait-time">${waitTimeDisplay}s</span>)`);

                const newWin = window.open(targetUrl, '_blank', 'width=600,height=400');

                if (!newWin) {
                    log("âŒ è¦–çª—è¢«æ””æˆªï¼è«‹å…è¨±å½ˆå‡ºè¦–çª—ã€‚");
                    stopProcess();
                    return;
                }

                // ç­‰å¾…éš¨æ©Ÿæ™‚é–“
                await new Promise(resolve => setTimeout(resolve, waitTimeMs));

                if (!newWin.closed) newWin.close();

                // ç¨å¾®ä¼‘æ¯
                await new Promise(resolve => setTimeout(resolve, 500));
            }

            if (isRunning) {
                log("âœ… ä»»å‹™å®Œæˆï¼");
                stopProcess();
            }
        }
    </script>
</body>
</html>
